<h1 class="text-white">Log In</h1>
<div class="card card-body">
	<p>Enter your credentials into the form below to log in</p>

	<form id="login" method="post">
		<div id="error" class="alert alert-danger d-none">
		</div>

		<div class="form-floating mb-3">
			<input type="email" name="email" id="email" maxlength="255" placeholder="Email address" class="form-control" value="{{email}}" required />
			<label class="form-label" for="email">Email address</label>
		</div>

		<div class="form-floating mb-3">
			<input type="password" name="password" maxlength="72" id="password" placeholder="Password" class="form-control" required />
			<label class="form-label" for="password">Password</label>
		</div>

		<button type="submit" class="btn btn-default btn-lg">Log In</button>

		<a href="/organisation/new" class="d-block d-lg-inline ms-lg-5">I want to register my band</a>
	</form>

</div>

<script>
	const error = document.getElementById("error");
	const form = document.getElementById("login");
	const email = document.getElementById("email");
	const password = document.getElementById("password");

	function showErrors(errors){
		error.innerHTML = errors.map(e => e.message).join("<br />");
		error.classList.remove("d-none");
	}

	form.addEventListener("submit", async (e) => {
		e.preventDefault();
		error.classList.add("d-none");
		email.disabled = true;
		password.disabled = true;
		
		const response = await fetch("https://dev.payload.byba.online/api/users/login", {
			method: 'POST',
			headers: {
				"Content-Type": "application/json"
			},
			body: JSON.stringify({
				email: email.value,
				password: password.value
			})
		});

		const json = await response.json();

		email.disabled = false;
		password.disabled = false;

		if(response.status / 100 != 2){
			showErrors(json.errors);
			return;
		}

		await fetch("/_api/users/set-user", {
			method: 'POST',
			body: JSON.stringify({
				email: email.value,
				password: password.value,
				payload: json
			})
		});
	});
</script>