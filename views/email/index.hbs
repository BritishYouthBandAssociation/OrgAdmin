<h2>Bulk Emailer</h2>

<div id="app">
	<div class="card mb-3">
		<div class="card-body">
			<h3 class="mb-3">Recipients</h3>
			<button type="button" class="btn btn-default" data-bs-toggle="modal" data-bs-target="#recipientModal">+
				Add</button>

			<div>
			</div>
		</div>
	</div>

	<div class="card card-body mb-3">
		<h3>Message Details</h3>

		<div class="form-group mb-3">
			<label for="sender">From</label>
			<input id="sender" name="sender" type="text" class="form-control" readonly value="{{session.user.Email}}" />
		</div>

		<div class="form-group mb-3">
			<label for="subject">Subject</label>
			<input id="subject" name="subject" type="text" class="form-control" required />
		</div>

		<div class="form-group">
			<label for="message">Message</label>
			<textarea id="message" name="message" class="form-control" rows="7" required></textarea>
		</div>
	</div>

	<div class="text-center">
		<button type="button" class="btn btn-success btn-lg mx-3">Send Test Email</button>
		<button type="button" class="btn btn-default btn-lg mx-3">Send Live Email</button>
	</div>

	<div class="modal fade" id="recipientModal" tabindex="-1" aria-hidden="true">
		<div class="modal-dialog modal-lg">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title">Add Recipients</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
				</div>
				<div class="modal-body">
					<div class="form-group">
						<label for="m-type">Membership Type</label>
						<select id="m-type" class="form-control" v-model="membershipType" v-on:change="loadMembers">
							<option value="*">All</option>
							{{#each types}}
							<option value="{{id}}">{{Name}} ({{#if
								IsOrganisation}}Organisation{{else}}Individual{{/if}})</option>
							{{/each}}
						</select>
					</div>

					<hr />

					<div class="text-center my-3" v-if="isLoading">
						<span class="fst-italic">Loading...</span>
						<div class="spinner-border" role="status">
							<span class="visually-hidden">Loading...</span>
						</div>
					</div>

					<div class="list-group" v-if="!isLoading">
						<label class="list-group-item" v-for="result in results">
							<input type="checkbox" class="form-check-input me-1" />${result.Organisation} - ${result.User}
							&lt;${result.Email}&gt;
						</label>
					</div>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
					<button type="button" class="btn btn-default">Add Recipients</button>
				</div>
			</div>
		</div>
	</div>
</div>

<script src="https://cdn.jsdelivr.net/npm/vue@2/dist/vue.js"></script>
<script src="https://cdn.tiny.cloud/1/jqnpk42m2gmjlp5gypj3ynprfipj9tnptt7oyi1uux35know/tinymce/6/tinymce.min.js"
	referrerpolicy="origin"></script>
<script>
	const season = {{ season }};

	tinymce.init({
		selector: '#message',
		plugins: 'autolink lists advlist link preview code wordcount quickbars',
		toolbar_mode: 'floating',
		menubar: 'file edit view insert tools format custom',
		menu: {
			custom: {
				title: 'Add Data Field',
				items: 'firstname lastname bandname'
			}
		},
		setup: (editor) => {
			editor.ui.registry.addMenuItem('firstname', {
				text: 'Recipient First Name',
				onAction: () => editor.insertContent("${firstname}")
			});

			editor.ui.registry.addMenuItem('lastname', {
				text: 'Recipient Last Name',
				onAction: () => editor.insertContent("${lastname}")
			});

			editor.ui.registry.addMenuItem('bandname', {
				text: 'Band Name',
				onAction: () => editor.insertContent("${bandname}")
			});
		}
	});

	const app = new Vue({
		delimiters: ['${', '}'],
		el: '#app',
		data: {
			recipients: [],
			results: [],
			membershipType: '*',
			isLoading: false
		},
		methods: {
			loadMembers: function () {
				this.results = [];
				this.isLoading = true;

				fetch(`/_api/organisation?membership=${this.membershipType}&season=${season}`)
					.then(res => res.json())
					.then(json => {
						json.forEach(j => {
							j.OrganisationUsers.forEach(ou => {
								this.results.push({
									Organisation: j.Name,
									User: `${ou.User.FirstName} ${ou.User.Surname}`,
									Email: ou.User.Email
								});
							});
						});

						this.isLoading = false;
					});
			}
		}
	});
</script>